<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal | Meevbrandz</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #f8f9fc; --card: #ffffff; --text: #1a1a1a; --accent: #000; --danger: #e74c3c; --success: #27ae60; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin:0; min-height:100vh; }
        
        #login-view { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #000, #111); }
        #login-view > div { background: white; padding: 4rem 3rem; border-radius: 24px; box-shadow: 0 40px 100px rgba(0,0,0,0.6); max-width: 460px; width: 100%; text-align: center; }
        #login-view h2 { font-family: 'Playfair Display', serif; font-size: 3rem; margin-bottom: 2rem; color: #000; }
        #login-view input { width: 100%; padding: 1.2rem; margin-bottom: 1.2rem; border: 2px solid #ddd; border-radius: 14px; font-size: 1.1rem; transition: 0.3s; }
        #login-view input:focus { border-color: #000; outline: none; }
        #login-view button { width: 100%; padding: 1.3rem; background: #000; color: white; border: none; border-radius: 14px; font-size: 1.2rem; font-weight: 600; cursor: pointer; transition: 0.3s; }
        #login-view button:hover { background: #222; }

        #dashboard-view { display: none; padding: 5rem 2rem; max-width: 1400px; margin: 0 auto; }
        h1 { font-family: 'Playfair Display', serif; font-size: 4.2rem; margin: 0 0 1rem; color: #000; }
        .subtitle { font-size: 1.3rem; color: #555; margin-bottom: 4rem; }

        .tab-sub-nav { display: flex; gap: 3rem; margin: 3rem 0; border-bottom: 2px solid #eee; padding-bottom: 1rem; }
        .tab-sub-btn { cursor: pointer; font-weight: 600; font-size: 1.2rem; opacity: 0.6; position: relative; padding-bottom: 0.5rem; }
        .tab-sub-btn.active { opacity: 1; color: #000; }
        .tab-sub-btn.active::after { content: ''; position: absolute; bottom: -14px; left: 0; width: 100%; height: 5px; background: #000; border-radius: 3px; }

        .upload-zone { border: 4px dashed #aaa; border-radius: 28px; padding: 6rem 3rem; text-align: center; background: white; cursor: pointer; transition: all 0.4s; margin-bottom: 4rem; box-shadow: 0 15px 50px rgba(0,0,0,0.1); }
        .upload-zone:hover, .upload-zone.dragging { border-color: #000; background: #fafafa; transform: translateY(-8px); box-shadow: 0 30px 80px rgba(0,0,0,0.15); }
        .upload-zone h3 { margin: 0 0 0.8rem; font-size: 2.3rem; font-weight: 700; }
        .upload-zone p { color: #666; font-size: 1.2rem; }

        .media-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 2.5rem; }
        .media-card { background: white; border-radius: 24px; overflow: hidden; box-shadow: 0 12px 40px rgba(0,0,0,0.12); transition: all 0.4s; }
        .media-card:hover { transform: translateY(-16px); box-shadow: 0 35px 90px rgba(0,0,0,0.22); }
        .media-preview { aspect-ratio: 16/9; position: relative; background: #000; overflow: hidden; }
        .media-preview img, .media-preview video { width: 100%; height: 100%; object-fit: cover; }
        .media-type-badge { position: absolute; top: 16px; left: 16px; background: rgba(0,0,0,0.8); color: white; padding: 8px 16px; border-radius: 12px; font-weight: 700; font-size: 0.9rem; backdrop-filter: blur(4px); }
        .media-actions { padding: 1.6rem; display: flex; justify-content: space-between; align-items: center; background: #fdfdfd; border-top: 1px solid #f0f0f0; }
        .media-actions span { font-weight: 600; font-size: 1rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .media-actions button { background: var(--danger); color: white; border: none; padding: 0.8rem 1.8rem; border-radius: 12px; cursor: pointer; font-weight: 600; transition: 0.3s; }
        .media-actions button:hover { background: #c0392b; transform: scale(1.05); }

        .spinner { border: 8px solid #f0f0f0; border-top: 8px solid #000; border-radius: 50%; width: 70px; height: 70px; animation: spin 1s linear infinite; margin: 3rem auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .logout-btn { padding: 1.3rem 3.5rem; background: #000; color: white; border: none; border-radius: 16px; font-size: 1.3rem; font-weight: 600; cursor: pointer; margin-top: 5rem; transition: 0.3s; }
        .logout-btn:hover { background: #222; }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-view">
        <div>
            <h2>Admin Portal</h2>
            <form id="login-form">
                <input type="email" id="admin-email" placeholder="admin@meevbrandz.com" required>
                <input type="password" id="admin-password" placeholder="Password" required>
                <button type="submit">Enter Dashboard</button>
                <p id="login-error" style="color:#e74c3c;margin-top:1rem;display:none;"></p>
            </form>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard-view">
        <h1>Media Management</h1>
        <p class="subtitle">Upload, preview, and manage all your portfolio images & videos</p>

        <div class="tab-sub-nav">
            <div class="tab-sub-btn active" data-filter="all">All Media</div>
            <div class="tab-sub-btn" data-filter="image">Images</div>
            <div class="tab-sub-btn" data-filter="video">Videos</div>
        </div>

        <div class="upload-zone" id="upload-dropzone">
            <h3>Drop files here or click to upload</h3>
            <p>Images & videos • Any size • Multiple files</p>
            <input type="file" id="media-upload" multiple accept="image/*,video/*" style="display:none;">
        </div>

        <div id="upload-status" style="text-align:center;margin:2rem 0;font-weight:600;"></div>
        <div class="media-grid" id="media-grid"></div>

        <div style="text-align:center;">
            <button class="logout-btn" onclick="supabase.auth.signOut().then(()=>location.reload())">Logout</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabase = window.supabase.createClient(
            'https://dcwmqnonfruqgrzaqbas.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRjd21xbm9uZnJ1cWdyemFxYmFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1ODc0NjAsImV4cCI6MjA4MDE2MzQ2MH0.vxHW-xZpbVuhjjaK66b5sOQkIHLamEB7KDE8j5eVFN8'
        );

        const loginView = document.getElementById('login-view');
        const dashboardView = document.getElementById('dashboard-view');
        const mediaGrid = document.getElementById('media-grid');

        // Auto-login
        supabase.auth.getSession().then(({ data: { session } }) => session && showDashboard());

        document.getElementById('login-form').onsubmit = async e => {
            e.preventDefault();
            const { error } = await supabase.auth.signInWithPassword({
                email: document.getElementById('admin-email').value.trim(),
                password: document.getElementById('admin-password').value
            });
            if (error) {
                document.getElementById('login-error').textContent = error.message;
                document.getElementById('login-error').style.display = 'block';
            } else {
                showDashboard();
            }
        };

        async function showDashboard() {
            loginView.style.display = 'none';
            dashboardView.style.display = 'block';
            loadMedia();
        }

        async function loadMedia() {
            const { data } = await supabase.storage.from('portfolio_media').list('');
            mediaGrid.innerHTML = '';

            if (!data || data.length === 0) {
                mediaGrid.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:#999;font-size:1.5rem;margin:6rem 0;">No media yet — time to upload your work!</p>';
                return;
            }

            // Load saved signed URLs from localStorage
            const signedUrls = JSON.parse(localStorage.getItem('meev_signed_urls') || '{}');

            data.forEach(async file => {
                if (file.name.startsWith('.') || file.name.includes('emptyFolder')) return;

                let url = supabase.storage.from('portfolio_media').getPublicUrl(file.name).data.publicUrl;

                // Use signed URL if we have one (always works)
                if (signedUrls[file.name]) {
                    url = signedUrls[file.name];
                }

                const isVideo = /\.(mp4|webm|mov|avi|mkv)$/i.test(file.name);

                const card = document.createElement('div');
                card.className = 'media-card';
                card.dataset.type = isVideo ? 'video' : 'image';
                card.innerHTML = `
                    <div class="media-preview">
                        <span class="media-type-badge">${isVideo ? 'VIDEO' : 'IMAGE'}</span>
                        ${isVideo 
                            ? `<video src="${url}#t=0.1" preload="metadata" controls muted playsinline></video>`
                            : `<img src="${url}" loading="lazy" alt="${file.name}">`
                        }
                    </div>
                    <div class="media-actions">
                        <span title="${file.name}">${file.name.length > 28 ? file.name.substring(0,25)+'...' : file.name}</span>
                        <button onclick="deleteFile('${file.name}')">Delete</button>
                    </div>
                `;
                mediaGrid.appendChild(card);

                // If no signed URL yet, generate one now (for older files)
                if (isVideo && !signedUrls[file.name]) {
                    const { data: signed } = await supabase.storage
                        .from('portfolio_media')
                        .createSignedUrl(file.name, 60*60*24*365*10); // 10 years
                    if (signed) {
                        signedUrls[file.name] = signed.signedUrl;
                        localStorage.setItem('meev_signed_urls', JSON.stringify(signedUrls));
                        // Update the video source
                        card.querySelector('video').src = signed.signedUrl + '#t=0.1';
                    }
                }
            });
        }

        window.deleteFile = async name => {
            if (!confirm(`Permanently delete "${name}"?`)) return;
            await supabase.storage.from('portfolio_media').remove([name]);
            // Remove from localStorage too
            const signedUrls = JSON.parse(localStorage.getItem('meev_signed_urls') || '{}');
            delete signedUrls[name];
            localStorage.setItem('meev_signed_urls', JSON.stringify(signedUrls));
            loadMedia();
        };

        // UPLOAD — NOW GENERATES SIGNED URLS AUTOMATICALLY
        const dropzone = document.getElementById('upload-dropzone');
        dropzone.onclick = () => document.getElementById('media-upload').click();

        ['dragover', 'dragenter'].forEach(ev => dropzone.addEventListener(ev, e => { e.preventDefault(); dropzone.classList.add('dragging'); }));
        ['dragleave', 'drop'].forEach(ev => dropzone.addEventListener(ev, () => dropzone.classList.remove('dragging')));
        dropzone.ondrop = e => { e.preventDefault(); handleFiles(e.dataTransfer.files); };
        document.getElementById('media-upload').onchange = e => handleFiles(e.target.files);

        async function handleFiles(files) {
            if (!files.length) return;

            document.getElementById('upload-status').innerHTML = '<div class="spinner"></div><p>Uploading & making videos playable...</p>';

            const signedUrls = JSON.parse(localStorage.getItem('meev_signed_urls') || '{}');

            for (const file of files) {
                const safeName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.()_-]/g, '_')}`;

                // Upload with correct mime type
                const { error: uploadError } = await supabase.storage
                    .from('portfolio_media')
                    .upload(safeName, file, {
                        upsert: true,
                        contentType: file.type || 'application/octet-stream'
                    });

                if (uploadError) {
                    console.error('Upload failed:', uploadError);
                    continue;
                }

                // Generate long-lived signed URL
                const { data: signed } = await supabase.storage
                    .from('portfolio_media')
                    .createSignedUrl(safeName, 60*60*24*365*10); // 10 years

                if (signed) {
                    signedUrls[safeName] = signed.signedUrl;
                }
            }

            localStorage.setItem('meev_signed_urls', JSON.stringify(signedUrls));

            document.getElementById('upload-status').innerHTML = '<p style="color:var(--success);font-size:1.5rem;">All files uploaded & playable!</p>';
            setTimeout(() => document.getElementById('upload-status').innerHTML = '', 5000);
            loadMedia();
        }

        // Fixed filter tabs
        document.querySelectorAll('.tab-sub-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.tab-sub-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                const type = this.getAttribute('data-filter');
                document.querySelectorAll('.media-card').forEach(card => {
                    card.style.display = (type === 'all' || card.dataset.type === type) ? 'block' : 'none';
                });
            });
        });
    </script>
</body>
</html>